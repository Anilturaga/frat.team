<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>FRAT</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-orange.min.css" />
    <script src="https://code.getmdl.io/1.3.0/material.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Bungee+Inline&display=swap" rel="stylesheet">
    <link rel="stylesheet" type="text/css" href="./styles/trStyle.css">
    <link rel="stylesheet" href="./styles/normalize.min.css">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/5.0.0/normalize.min.css">
    <link rel='stylesheet' href='https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.3.0/css/font-awesome.css'>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prefixfree/1.0.7/prefixfree.min.js"></script>
    <style>
        .title {
            font-family: "Bungee Inline", Arial, Helvetica, sans-serif;
        }

        .box {
            width: 120px;
            height: 30px;
            border: 1px solid #999;
            font-size: 18px;
            color: indigo;
            background-color: orange;
            border-radius: 5px;
        }

        .viewSource {
            position: fixed;
            left: 0;
            top: 0;
            display: none;
            margin-left: 7px;
            margin-top: 7px;
            z-index: 900;
        }
    </style>

</head>

<body>
    <!-- partial:index.partial.html -->
    <div class="ct" id="t1">
        <div class="ct" id="t2">
            <div class="ct" id="t3">
                <div class="ct" id="t4">
                    <div class="ct" id="t5">
                        <ul id="menu">
                            <a href="#t1" onclick="tejaFuckedUp()">
                                <li class="icon fa fa-home fa-2x" id="uno"></li>
                            </a>
                            <a href="#t2" onclick="tejaFuckedUp()">
                                <li class="icon fa fa-video-camera fa-2x" id="dos"></li>
                            </a>
                            <a href="#t3" onclick="tejaFuckedUp()">
                                <li class="icon fa fa-square fa-2x" id="tres"></li>
                            </a><a href="#t4" onclick="tejaFuckedUpYes()">
                                <li class="icon fa fa-cog fa-2x" id="tres"></li>
                            </a>
                        </ul>
                        <div class="page" id="p1">
                            <section class="icon fa fa-book"><span class="title">FRAT</span><span class="hint">India's
                                    first 3D virtual classroom <br> with smart attendance, on the fly quizzes and shared
                                    whiteboard<br><br><br><button class="box" onclick="leaveClassFunction()">Leave
                                        class</button></span></section>

                        </div>
                        <div class="page mdl-grid" id="p2">
                            <div id="meet"
                                class="mdl-cell mdl-cell--11-col-desktop mdl-cell--7-col-tablet mdl-cell--3-col-phone"
                                style="padding: 0%;margin: 0%;"></div>
                        </div>
                        <div class="page mdl-grid" id="p3">
                            <div id="whiteboard"
                                class="mdl-cell mdl-cell--11-col-desktop mdl-cell--7-col-tablet mdl-cell--3-col-phone"
                                style="padding: 0%;margin: 0%;"></div>
                        </div>
                        <div class="page pageSett" id="p4">
                            <section id="tejaFuckedUpID" style="display: none;">
                                <div class="mdl-grid" id="attLoadingScreen"
                                    style="display: none;text-align: center;align-self: center;justify-content: center;">
                                    <div class="mdl-spinner mdl-js-spinner is-active"></div>
                                    <h4>Please wait while we collect attendance from students devices</h4>
                                    <h6>This may take a while.<br>You'll be redirected to download the excel sheet</h6>
                                </div>
                                <div class="mdl-grid" id="settingsPageContent">
                                    <ul class="demo-list-control mdl-list mdl-cell mdl-cell--11-col-desktop mdl-cell--7-col-tablet mdl-cell--3-col-phone"
                                        style="padding: 0%;margin: 0%;">
                                        <li class="mdl-list__item mdl-list__item--two-line mdl-color-text--white">
                                            <span class="mdl-list__item-primary-content">
                                                <i class="material-icons  mdl-list__item-icon">fact_check</i>
                                                <span>Conduct quiz</span>
                                                <span class="mdl-list__item-sub-title mdl-color-text--blue-grey-100">No
                                                    new participants will be
                                                    allowed.</span>
                                            </span>
                                            <span class="mdl-list__item-secondary-action">
                                                <select class="box" id="professsion" name="quiz"
                                                    onchange="conductQuizFunction()">
                                                    <option value=""></option>
                                                </select>
                                            </span>
                                        </li>
                                        <li class="mdl-list__item mdl-list__item--two-line mdl-color-text--white">
                                            <span class="mdl-list__item-primary-content">
                                                <i class="material-icons  mdl-list__item-icon">lock</i>
                                                <span>Close room</span>
                                                <span class="mdl-list__item-sub-title mdl-color-text--blue-grey-100">No
                                                    new participants will be
                                                    allowed.</span>
                                            </span>
                                            <span class="mdl-list__item-secondary-action">
                                                <label class="mdl-switch mdl-js-switch mdl-js-ripple-effect"
                                                    for="list-switch-1">
                                                    <input type="checkbox" id="list-switch-1" class="mdl-switch__input"
                                                        id="closeRoom" onclick="closeRoomFunction()" />
                                                </label>
                                            </span>
                                        </li>
                                        <li class="mdl-list__item mdl-list__item--two-line mdl-color-text--white">
                                            <span class="mdl-list__item-primary-content">
                                                <i
                                                    class="material-icons  mdl-list__item-icon">supervised_user_circle</i>
                                                <span>Take attendance</span>
                                                <span
                                                    class="mdl-list__item-sub-title mdl-color-text--blue-grey-100">Automatically
                                                    give attendance
                                                    only to
                                                    students
                                                    who paid attention for at least 50% of the class</span>
                                            </span>
                                            <span class="mdl-list__item-secondary-action">
                                                <button
                                                    class="mdl-button mdl-js-button mdl-button--fab mdl-js-ripple-effect mdl-button--colored"
                                                    onclick="attendanceFunction()">
                                                    <i class="material-icons">check</i>
                                                </button>

                                            </span>
                                        </li>
                                    </ul>
                                </div>
                            </section>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <a id="view-source1"
        class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-color--accent mdl-color-text--white viewSource"
        onclick="startClassFunction()">Start class</a>
    <a id="view-source2"
        class="mdl-button mdl-js-button mdl-button--raised mdl-js-ripple-effect mdl-color--accent mdl-color-text--white viewSource"
        onclick="stopClassFunction()">Stop class</a>
</body>
<script src='https://meet.jit.si/external_api.js'></script>

<script src="/__/firebase/7.17.1/firebase-app.js"></script>
<script src="/__/firebase/7.17.1/firebase-firestore.js"></script>
<script src="/__/firebase/7.17.1/firebase-auth.js"></script>
<script src="/__/firebase/init.js"></script>
<script>
    function tejaFuckedUp() {
        document.getElementById("tejaFuckedUpID").style.display = "none"
    }
    function tejaFuckedUpYes() {
        document.getElementById("tejaFuckedUpID").style.display = "block"
    }
    var USER_CRED
    var db = firebase.firestore();

    firebase.auth().onAuthStateChanged(function (user) {
        if (user && user.isAnonymous === false) {
            USER_CRED = user;
            //alert("hey guy")
            //email = user.email;
            //photoUrl = user.photoURL;;
            var washingtonRef = db.collection("rooms").doc(localStorage.getItem("roomID"));

            // Set the "capital" field of the city 'DC'
            return washingtonRef.update({
                teacher: user.email
            })
                .then(function () {
                    console.log("Document successfully updated!");
                })
                .catch(function (error) {
                    // The document probably doesn't exist.
                    console.error("Error updating document: ", error);
                })

        } else {
            //alert("Dwight, get out of my nook")
            window.location.replace("/login.html");
        }
    });
    document.getElementById("view-source1").style.display = "none"
    document.getElementById("view-source2").style.display = "none"

    db.collection("rooms").doc(localStorage.getItem("roomID"))
        .onSnapshot(function (snapshot) {
            console.log("|||||||||||||||||||||||||||||||||||||||||||||||||", snapshot.data())
            //quizFormBit
            try {
                var startClass = snapshot.data().startClass
                if (startClass === false) {
                    console.log("class not started")
                    document.getElementById("view-source2").style.display = "none"
                    document.getElementById("view-source1").style.display = "block"
                } else if (startClass === true) {
                    document.getElementById("view-source1").style.display = "none"
                    document.getElementById("view-source2").style.display = "block"
                }
            } catch (e) {
                console.log("not yet")
            }
        });
    setTimeout(function () {
        console.log("**************************************")
        db.collection("users")
            .doc(USER_CRED.email)
            .collection("quiz")
            .get()
            .then(function (querySnapshot) {
                //console.log(querySnapshot.docs)

                if (querySnapshot.docs.length === 0) {
                    console.log("ggggggggggggggggggggggggggggggg")

                }
                querySnapshot.forEach(function (doc) {
                    console.log("efffffffffffff")

                    var d1 = document.getElementById("professsion");
                    const quizName = doc.data().quizName;
                    const quizLink = doc.data().quizLink;
                    d1.insertAdjacentHTML(
                        "beforeend",
                        '<option value="' + quizLink + '">' + quizName + '</option>'
                    );
                    console.log(d1)
                });
            })
            .catch(function (error) {
                console.log("Error getting document:", error);
            });
        api.executeCommand('displayName', USER_CRED.displayName);

    }, 3000);

    //FIX THIS
    var clientHeight = document.documentElement.scrollHeight;

    db.collection("rooms").doc(localStorage.getItem("roomID"))
        .onSnapshot(function (snapshot) { console.log("|||||||||||||||||||||||||||||||||||||||||||||||||", snapshot.data()) });

    const domain = 'meet.jit.si';
    const options = {
        roomName: localStorage.getItem("jitsi"),
        height: clientHeight,
        parentNode: document.querySelector('#meet'),
        configOverwrite: { startWithAudioMuted: true, startWithVideoMuted: true, disableDeepLinking: true },
        interfaceConfigOverwrite: {
            TOOLBAR_BUTTONS: [
                'microphone', 'camera', 'closedcaptions', 'desktop', 'embedmeeting', 'fullscreen',
                'fodeviceselection', 'profile', 'chat', 'recording',
                'livestreaming', 'etherpad', 'sharedvideo', 'settings',
                'videoquality', 'filmstrip', 'shortcuts', 'videobackgroundblur', 'mute-everyone',
            ],
            filmStripOnly: false, MOBILE_APP_PROMO: false, HIDE_INVITE_MORE_HEADER: true, SHOW_CHROME_EXTENSION_BANNER: false, SHOW_JITSI_WATERMARK: false,
            SHOW_PROMOTIONAL_CLOSE_PAGE: false,
            SHOW_WATERMARK_FOR_GUESTS: false,
            DEFAULT_REMOTE_DISPLAY_NAME: 'Student', DISPLAY_WELCOME_PAGE_CONTENT: false, ENABLE_DIAL_OUT: false,
        },
    };
    const api = new JitsiMeetExternalAPI(domain, options);
    //document.getElementById('jitsiConferenceFrame0').allow = "camera;microphone"
    //document.getElementById('jitsiConferenceFrame0').style.overflow = "none"

    var d1 = document.getElementById("whiteboard");
    d1.insertAdjacentHTML(
        "beforeend", '<iframe id="wbo" height="' + clientHeight + '" src="https://wbo.ophir.dev/boards/' + localStorage.getItem("whiteboard") + '" title="whiteboard">')
    document.getElementById("wbo").seamless = true;
    function conductQuizFunction() {
        var x = document.getElementById("professsion").value;
        console.log("Quiz ", localStorage.getItem("roomID"))
        var cityRef = db.collection("rooms").doc(localStorage.getItem("roomID"));
        var setWithMerge = cityRef.set({
            quizForm: x
        }, { merge: true });

    }
    function closeRoomFunction() {
        var x = document.getElementById("closeRoom").checked;
        if (x === true) {
            var cityRef = db.collection("rooms").doc(localStorage.getItem("roomID"));
            var setWithMerge = cityRef.set({
                closed: true,
            }, { merge: true });
        } else {
            var cityRef = db.collection("rooms").doc(localStorage.getItem("roomID"));
            var setWithMerge = cityRef.set({
                closed: false,
            }, { merge: true });
        }
    }
    function startClassFunction() {
        var date = new Date();
        var timestamp = date.getTime();
        var cityRef = db.collection("rooms").doc(localStorage.getItem("roomID"));
        var setWithMerge = cityRef.set({
            startTime: timestamp,
            startClass: true,
        }, { merge: true });
        db.collection("rooms").doc(localStorage.getItem("roomID")).collection("meta").doc("attendance").delete().then(function () {
            console.log("Document successfully deleted!");
        }).catch(function (error) {
            console.error("Error removing document: ", error);
        });
    }

    function stopClassFunction() {
        var cityRef = db.collection("rooms").doc(localStorage.getItem("roomID"));
        var setWithMerge = cityRef.set({
            startClass: false,
        }, { merge: true });

        document.getElementById("settingsTab").click()
        //alert("Go to settings page to collect attendance")
    }

    function attendanceFunction() {
        document.getElementById("settingsPageContent").style.display = "none"
        document.getElementById("attLoadingScreen").style.display = "block"

        setTimeout(callAttendanceFirebaseFunction, 1000)
    }
    function leaveClassFunction() {
        window.location.replace("/console");

    }
    function callAttendanceFirebaseFunction() {
        //http://localhost:5005/fir-rtc-926a7/us-central1/widgets
        var attObj = {
            roomID: localStorage.roomID,
            email: USER_CRED.email
        }
        const linkToAtt = "https://asia-south1-fir-rtc-926a7.cloudfunctions.net/widgets/attendance?roomID=" + localStorage.roomID + "&displayName=" + USER_CRED.displayName
        window.open(linkToAtt)

        document.getElementById("settingsPageContent").style.display = "block"
        document.getElementById("attLoadingScreen").style.display = "none"

        /*
        fetch(
            "http://localhost:5005/fir-rtc-926a7/us-central1/widgets/test",
            {
                method: "POST", // or 'PUT'
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify(attObj),
            }
        ).then((response) => {
            console.log(typeof (response.body));
            var w = window.open('about:blank');
            w.document.open();
            w.document.write(response.body);
            w.document.close();
            //data = new Blob([response.data], {type: "application/vnd.ms-excel"});
            //window.open(data)

            console.log("22222222222222222222222222")
        });*/
        //window.location.replace("/console.html");

    }
</script>

</html>